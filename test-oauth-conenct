// uploadDrive_localhost.js
import fs from 'fs';
import { google } from 'googleapis';
import http from 'http';
import url from 'url';

const SCOPES = ['https://www.googleapis.com/auth/drive.file'];
const TOKEN_PATH = './token.json';

async function main() {
  try {
    console.log('üì§ Google Drive Upload\n');
    
    // 1. Charger credentials
    const content = fs.readFileSync('./credentials.json', 'utf8');
    const credentials = JSON.parse(content);
    
    // 2. Configurer OAuth avec localhost
    const { client_id, client_secret } = credentials.installed || credentials.web;
    const redirectUri = 'http://localhost:3000/callback';
    
    const oAuth2Client = new google.auth.OAuth2(
      client_id,
      client_secret,
      redirectUri
    );
    
    // 3. V√©rifier token existant
    if (fs.existsSync(TOKEN_PATH)) {
      console.log('‚úÖ Token existant');
      const token = JSON.parse(fs.readFileSync(TOKEN_PATH, 'utf8'));
      oAuth2Client.setCredentials(token);
      console.log('üéâ Authentifi√© !');
      return;
    }
    
    // 4. G√©n√©rer URL d'autorisation
    const authUrl = oAuth2Client.generateAuthUrl({
      access_type: 'offline',
      scope: SCOPES,
      prompt: 'consent'
    });
    
    console.log('\nüëâ √âTAPES :');
    console.log('1. Ouvre ce lien dans Chrome :');
    console.log(authUrl);
    console.log('\n2. Autorise l\'application');
    console.log('3. Tu seras redirig√© vers localhost');
    console.log('4. Le code sera captur√© automatiquement\n');
    
    // 5. D√©marrer un mini serveur pour recevoir le redirect
    const code = await startServerAndGetCode(oAuth2Client);
    
    // 6. √âchanger code contre token
    const { tokens } = await oAuth2Client.getToken(code);
    oAuth2Client.setCredentials(tokens);
    
    // 7. Sauvegarder token
    fs.writeFileSync(TOKEN_PATH, JSON.stringify(tokens));
    console.log('‚úÖ Token sauvegard√© !');
    
  } catch (error) {
    console.error('‚ùå ERREUR :', error.message);
  }
}

function startServerAndGetCode(oAuth2Client) {
  return new Promise((resolve, reject) => {
    const server = http.createServer(async (req, res) => {
      try {
        const query = url.parse(req.url, true).query;
        
        if (query.code) {
          // Code re√ßu !
          res.writeHead(200, { 'Content-Type': 'text/html' });
          res.end(`
            <html>
              <body>
                <h1>Authentification r√©ussie !</h1>
                <p>Tu peux fermer cette fen√™tre et retourner au terminal.</p>
              </body>
            </html>
          `);
          
          // Arr√™ter le serveur
          server.close();
          resolve(query.code);
          
        } else if (query.error) {
          res.writeHead(400, { 'Content-Type': 'text/html' });
          res.end(`<h1>Erreur: ${query.error}</h1>`);
          server.close();
          reject(new Error(query.error));
        }
      } catch (err) {
        server.close();
        reject(err);
      }
    });
    
    server.listen(3000, () => {
      console.log('üîÑ Serveur en attente sur http://localhost:3000');
    });
    
    // Timeout apr√®s 2 minutes
    setTimeout(() => {
      server.close();
      reject(new Error('Timeout - Aucune r√©ponse re√ßue'));
    }, 120000);
  });
}

main();